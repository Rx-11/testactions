name: Test Webhook Server

on: 
  workflow_dispatch:
    # You can also trigger on push/pull_request if you like.
    # This example uses workflow_dispatch for manual triggers.

jobs:
  run-webhook-server:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Install ngrok
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip
          wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
          unzip ngrok-stable-linux-amd64.zip -d /usr/local/bin
          ngrok version

      - name: Start ngrok tunnel
        run: |
          # Spin up ngrok to tunnel port 3000 publicly
          ngrok http 3000 --log=stdout > ngrok.log 2>&1 &
          # Wait for ngrok to initialize
          sleep 5

      - name: Retrieve ngrok public URL
        id: ngrok-url
        run: |
          # Query ngrok API to get the public URL
          NGROK_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          echo "NGROK_URL=$NGROK_URL" >> $GITHUB_ENV
        # We'll store NGROK_URL in GitHub Actions environment variable for later use

      - name: Show the public URL
        run: |
          echo "Your public tunnel URL is: $NGROK_URL"
          echo "Use this URL as the webhook target."

      - name: Keep the job alive (for testing)
        run: |
          echo "Keeping the job alive to receive webhook events..."
          echo "Press Ctrl+C or cancel the workflow run once you've tested your webhook."
          sleep 600
          # The above sleeps for 600 seconds (10 minutes).
          # Adjust to how long you want to keep the server up.
