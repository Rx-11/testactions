name: Generate Dog Image

on:
  workflow_dispatch:  # Allows you to trigger this workflow manually in the Actions tab

jobs:
  generate_and_commit:
    runs-on: ubuntu-latest

    # This permission is needed to push changes (i.e., to commit generated images).
    permissions:
      contents: write

    steps:
      - name: Check out the repository
        uses: actions/checkout@v3
        with:
          persist-credentials: false  # We'll set up our own git credentials for commit

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          # Install CPU-based PyTorch, Diffusers, Transformers, Accelerate, Safetensors, etc.
          python -m pip install --upgrade pip
          python -m pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
          python -m pip install diffusers transformers accelerate safetensors

      - name: Generate dog image
        run: |
          echo "Generating dog image via Stable Diffusion..."
          python -c "
          import torch
          from diffusers import StableDiffusionPipeline

          model_id = 'runwayml/stable-diffusion-v1-5'
          pipe = StableDiffusionPipeline.from_pretrained(model_id, torch_dtype=torch.float32)
          pipe = pipe.to('cpu')

          prompt = 'A cute dog playing fetch in a sunny park, ultra realistic, 4K photography'
          image = pipe(prompt).images[0]
          image.save('dog.png')
          "
      
      - name: Configure git
        run: |
          git config --global user.email "triksters123@gmail.com"
          git config --global user.name "Rx-11"
      
      - name: Commit and push changes
        run: |
          git add dog.png
          git commit -m "chore: generate dog image"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
