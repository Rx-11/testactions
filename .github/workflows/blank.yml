name: Test Webhook Server

# Manually trigger for testing
on: 
  workflow_dispatch:

# Ensure we have write permissions so we can push to the repo
permissions:
  contents: write

jobs:
  run-webhook-server:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Install ngrok
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip
          wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
          unzip ngrok-stable-linux-amd64.zip -d /usr/local/bin
          ngrok version

      - name: Start ngrok tunnel
        run: |
          # Spin up ngrok to tunnel port 3000 publicly
          ngrok http 3000 --log=stdout > ngrok.log 2>&1 &
          sleep 5  # wait for ngrok to fully initialize

      - name: Retrieve ngrok public URL
        id: ngrok-url
        run: |
          NGROK_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          echo "NGROK_URL=$NGROK_URL" >> $GITHUB_ENV

      - name: Show the public URL
        run: |
          echo "Your public tunnel URL is: $NGROK_URL"
          echo "Use this URL as the webhook target."

      - name: Write public URL to a file
        run: |
          echo "$NGROK_URL" > server_url.txt

      - name: Commit the file
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add server_url.txt
          git commit -m "Add ngrok public URL from workflow run"
          git push

      - name: Keep the job alive (for testing)
        run: |
          echo "Keeping the job alive to receive webhook events..."
          sleep 300
