name: Generate Dog Image

on:
  workflow_dispatch:  # Allows you to trigger this workflow manually in the Actions tab

jobs:
  generate_and_commit:
    runs-on: ubuntu-latest

    # This permission is needed to push changes (i.e., to commit generated images).
    permissions:
      contents: write

    steps:
      - name: Check out the repository
        uses: actions/checkout@v3
        with:
          persist-credentials: false  # We'll set up our own git credentials for commit

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # CPU-only PyTorch
          python -m pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
          # Diffusers & friends
          python -m pip install diffusers transformers accelerate safetensors

      - name: Generate dog image
        run: |
          echo "Generating dog image (optimized for CPU)..."
          python -c "
          import torch
          from diffusers import StableDiffusionPipeline, EulerAncestralDiscreteScheduler

          model_id = 'runwayml/stable-diffusion-v1-5'

          print('Loading pipeline...')
          pipe = StableDiffusionPipeline.from_pretrained(
              model_id,
              torch_dtype=torch.float32  # Keep float32 on CPU (fp16 on CPU can cause issues)
          )

          # Use a faster scheduler
          pipe.scheduler = EulerAncestralDiscreteScheduler.from_config(pipe.scheduler.config)

          # Disable the safety checker (optional, speeds up generation)
          pipe.safety_checker = lambda images, clip_input: (images, False)

          pipe = pipe.to('cpu')

          # Lower resolution + fewer steps => faster inference on CPU
          prompt = 'A cute dog playing fetch in a sunny park, ultra realistic, 4K photography'
          image = pipe(
            prompt,
            height=256,
            width=256,
            num_inference_steps=20
          ).images[0]

          image.save('dog.png')
          "
      
      - name: Configure git
        run: |
          git config --global user.email "triksters123@gmail.com"
          git config --global user.name "Rx-11"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  
      
      - name: Commit and push changes
        run: |
          git add dog.png
          git commit -m "chore: generate dog image"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
