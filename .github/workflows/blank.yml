name: Ngrok Tunnel for App

on:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          curl -sSL https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip -o ngrok.zip
          unzip ngrok.zip
          chmod +x ngrok
          mv ngrok /usr/local/bin/ngrok
          echo "✅ Ngrok installed."

      - name: Authenticate Ngrok
        run: |
          ngrok authtoken ${{ secrets.NGROK_AUTHTOKEN }}
          echo "✅ Ngrok authenticated."

      - name: Start Ngrok Tunnel
        run: |
          nohup ngrok http 3000 > ngrok.log 2>&1 &  # Change port if needed
          sleep 10
          echo "✅ Ngrok started."

      - name: Fetch Ngrok Public URL
        run: |
          echo "⏳ Fetching Ngrok URL..."
          for i in {1..20}; do
            NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url' || echo "null")
            if [[ "$NGROK_URL" != "null" && "$NGROK_URL" != "" ]]; then
              echo "🚀 Ngrok Public URL: $NGROK_URL"
              echo "NGROK_URL=$NGROK_URL" >> $GITHUB_ENV
              exit 0
            fi
            echo "🔄 Retrying in 5 seconds..."
            sleep 5
          done
          echo "❌ ERROR: Ngrok did not return a public URL."
          exit 1

      - name: Start Application
        run: |
          npm install
          nohup npm start > app.log 2>&1 &
          echo "✅ Application started."

      - name: Keep Process Alive
        run: |
          echo "🔄 Keeping the process alive..."
          tail -f /dev/null
